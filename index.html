<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveSchool Points Tool</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <!-- SheetJS for XLSX parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Fuse.js for fuzzy matching -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Login Screen (shown until authenticated) -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>LiveSchool Points Tool</h1>
                <p>Internal tool for LiveSchool staff</p>
            </div>
            <div class="login-body">
                <p>Please sign in with your LiveSchool Google account to continue.</p>
                <div id="google-signin-btn"></div>
                <p class="login-hint">Only @liveschoolinc.com accounts are allowed</p>
            </div>
            <div id="login-error" class="login-error hidden"></div>
        </div>
    </div>

    <!-- Main App Container (hidden until authenticated) -->
    <div id="app-container" class="hidden">

    <!-- Welcome Modal (shows on first visit) -->
    <div id="welcome-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome to LiveSchool Points Tool</h2>
                <button class="modal-close" id="close-welcome">&times;</button>
            </div>
            <div class="modal-body">
                <p>This tool helps you bulk-assign behaviors to students in LiveSchool.</p>

                <div class="feature-cards">
                    <div class="feature-card">
                        <div class="feature-icon">üìã</div>
                        <h4>Assign Points</h4>
                        <p>Match student names from a school spreadsheet to LiveSchool IDs and generate scripts to assign behaviors.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üé≤</div>
                        <h4>Demo Data Generator</h4>
                        <p>Create randomized point history for demo sites with configurable ratios and date ranges.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üí∞</div>
                        <h4>Balance Transfer</h4>
                        <p>Transfer point balances from other systems to LiveSchool by matching student names to IDs.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">üîÄ</div>
                        <h4>Merge Students</h4>
                        <p>Replay behavior transactions from a duplicate student record onto the correct student.</p>
                    </div>
                </div>

                <div class="getting-started">
                    <h4>Getting Started</h4>
                    <ol>
                        <li>Choose your mode using the toggle at the top</li>
                        <li>Upload the required files (CSV export from LiveSchool)</li>
                        <li>Configure your site IDs and behaviors</li>
                        <li>Generate the script and paste it in LiveSchool's browser console</li>
                    </ol>
                </div>

                <button id="start-using" class="btn primary">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>What's New</h2>
                <button class="modal-close" id="close-changelog">&times;</button>
            </div>
            <div class="modal-body changelog-body">
                <div class="changelog-entry">
                    <div class="changelog-version">v2.4.0 <span class="changelog-date">February 2026</span></div>
                    <ul>
                        <li><strong>Improved: Merge Students</strong> - Now replays purchase/reward transactions (2-step API: POST /v2/rewards + PUT /fulfillments/deliver)</li>
                        <li>Teacher name attribution on all replayed transactions (e.g., "[Originally by Mr. Shealy]")</li>
                        <li>Unmapped reward names resolved via incentive ID input</li>
                    </ul>
                    <div class="changelog-version">v2.3.0 <span class="changelog-date">February 2026</span></div>
                    <ul>
                        <li><strong>New: Merge Students Mode</strong> - Replay behavior transactions from a duplicate student onto the correct record</li>
                        <li>Upload the extended data export (TSV) of the original student's transaction history</li>
                        <li>Import behavior JSON to map behavior names to IDs</li>
                        <li>Review and resolve unmapped behaviors before generating script</li>
                        <li>Generated script processes transactions sequentially with retry logic</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v2.2.3 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li><strong>Improved: Demo Data Generator</strong> - No longer requires demerit behaviors</li>
                        <li>Can now generate demo data with only merit behaviors (100% positive points)</li>
                        <li>Ratio auto-adjusts when only one behavior type is present</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v2.2.2 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li><strong>Improved: UX/UI overhaul</strong> - Enhanced visual design and usability</li>
                        <li>Settings dropdown menu replaces loose utility links (gear icon)</li>
                        <li>Stronger active state for mode toggle (bold + underline indicator)</li>
                        <li>SVG file type icons in upload zones</li>
                        <li>"Select File" buttons inside dropzones for clearer interaction</li>
                        <li>Help tooltips with format requirements</li>
                        <li>Improved accessibility with better text contrast</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v2.2.1 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li><strong>Improved: Balance Transfer script</strong> - Now uses browser's FormData API for proper multipart encoding</li>
                        <li>Added school-specific Reward ID field (required - varies by school)</li>
                        <li>Added test suite for Parser and Matcher modules</li>
                        <li>Added "Tests" link in header navigation for easy access to test suite</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v2.2.0 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li><strong>New: Balance Transfer Mode</strong> - Transfer point balances from other systems to LiveSchool</li>
                        <li>Upload school CSV with student names and point amounts</li>
                        <li>Match students using fuzzy name matching (handles "FirstName LastName" format)</li>
                        <li>Manual match resolution for unmatched students</li>
                        <li>Generates async script with retry logic for reliable transfers</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v2.1.0 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li><strong>New: Separate column support</strong> - Now supports school files with names in separate "Last Name" and "First Name" columns</li>
                        <li>Choose between "Combined column" or "Separate columns" when selecting name columns</li>
                        <li>Auto-detects column headers in separate column mode</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v2.0.0 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li><strong>New: Demo Data Generator</strong> - Create randomized point history for demo sites</li>
                        <li>Configure positive:negative ratios (3:1, 4:1, 5:1, etc.)</li>
                        <li>Set date ranges - points only on weekdays</li>
                        <li>PBIS-aligned comments - behavior-specific praise & respectful redirections</li>
                        <li>Import behaviors directly from LiveSchool API response</li>
                        <li>Behavior discovery script to find available behavior IDs</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v1.1.0 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li>Added retry script generation for failed batches</li>
                        <li>Improved error handling and progress logging</li>
                    </ul>
                </div>
                <div class="changelog-entry">
                    <div class="changelog-version">v1.0.0 <span class="changelog-date">January 2026</span></div>
                    <ul>
                        <li>Initial release</li>
                        <li>Name matching with fuzzy search</li>
                        <li>Batch processing with retry logic</li>
                        <li>Manual match resolution for unmatched students</li>
                    </ul>
                </div>
                <button id="close-changelog-btn" class="btn secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Sticky Summary Bar -->
    <div class="sticky-summary" id="sticky-summary">
        <!-- Assign Mode Summary -->
        <div class="summary-content assign-summary">
            <div class="summary-item" id="summary-school-file">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">School File</span>
            </div>
            <div class="summary-item" id="summary-liveschool-file">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">LiveSchool CSV</span>
            </div>
            <div class="summary-item" id="summary-config">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Config</span>
            </div>
            <div class="summary-item" id="summary-matched">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Matched</span>
            </div>
        </div>
        <!-- Demo Mode Summary -->
        <div class="summary-content demo-summary hidden">
            <div class="summary-item" id="demo-summary-students">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Students</span>
            </div>
            <div class="summary-item" id="demo-summary-config">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Config</span>
            </div>
            <div class="summary-item" id="demo-summary-behaviors">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Behaviors</span>
            </div>
            <div class="summary-item" id="demo-summary-settings">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Settings</span>
            </div>
        </div>
        <!-- Balance Transfer Mode Summary -->
        <div class="summary-content balance-summary hidden">
            <div class="summary-item" id="balance-summary-source">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Source File</span>
            </div>
            <div class="summary-item" id="balance-summary-liveschool">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">LiveSchool CSV</span>
            </div>
            <div class="summary-item" id="balance-summary-matched">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Matched</span>
            </div>
        </div>
        <!-- Merge Students Mode Summary -->
        <div class="summary-content merge-summary hidden">
            <div class="summary-item" id="merge-summary-ids">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Student IDs</span>
            </div>
            <div class="summary-item" id="merge-summary-log">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Points Log</span>
            </div>
            <div class="summary-item" id="merge-summary-behaviors">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Behaviors</span>
            </div>
            <div class="summary-item" id="merge-summary-mapped">
                <span class="summary-icon">‚óã</span>
                <span class="summary-label">Mapped</span>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="header-top">
                <div class="header-title">
                    <h1>LiveSchool Points Tool</h1>
                    <p class="subtitle">Match student names and generate behavior scripts</p>
                </div>
                <div class="header-actions">
                    <span id="user-email" class="user-email"></span>
                    <div class="settings-dropdown">
                        <button class="settings-btn" id="settings-toggle" title="Settings">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <div class="settings-menu hidden" id="settings-menu">
                            <button class="settings-item" id="show-changelog">
                                <span class="settings-icon">üì¢</span> What's New
                            </button>
                            <button class="settings-item" id="show-help">
                                <span class="settings-icon">‚ùì</span> Help
                            </button>
                            <a href="tests.html" class="settings-item">
                                <span class="settings-icon">üß™</span> Run Tests
                            </a>
                            <div class="settings-divider"></div>
                            <button class="settings-item settings-signout" id="sign-out-btn">
                                <span class="settings-icon">üö™</span> Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="assign">Assign Points</button>
                <button class="mode-btn" data-mode="demo">Demo Data Generator</button>
                <button class="mode-btn" data-mode="balance">Balance Transfer</button>
                <button class="mode-btn" data-mode="merge">Merge Students</button>
            </div>
        </header>

        <!-- Progress Indicator (Assign Mode) -->
        <div class="progress-bar assign-step">
            <div class="progress-step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Upload</div>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Columns</div>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Config</div>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Behaviors</div>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step" data-step="5">
                <div class="step-number">5</div>
                <div class="step-label">Match</div>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step" data-step="6">
                <div class="step-number">6</div>
                <div class="step-label">Generate</div>
            </div>
        </div>

        <!-- Step 1: File Upload -->
        <section class="step assign-step active" id="step-upload" data-step="1">
            <div class="step-header">
                <h2><span class="step-badge">1</span> Upload Files</h2>
            </div>
            <div class="step-content">
                <div class="upload-grid">
                    <div class="upload-box" id="school-dropzone">
                        <div class="dropzone-content">
                            <div class="upload-icon xlsx-icon">
                                <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                    <rect x="8" y="4" width="32" height="40" rx="2" fill="#22543d" stroke="#276749" stroke-width="2"/>
                                    <text x="24" y="28" text-anchor="middle" fill="white" font-size="10" font-weight="bold">XLSX</text>
                                </svg>
                            </div>
                            <label for="school-file">School's XLSX File</label>
                            <input type="file" id="school-file" accept=".xlsx,.xls">
                            <button type="button" class="select-file-btn">Select File</button>
                            <p class="upload-hint">or drag & drop here</p>
                            <p class="upload-desc">
                                Must contain a student name column
                                <span class="help-tooltip" title="Format: 'LASTNAME, FIRSTNAME' or separate columns. Names should include first and last name.">?</span>
                            </p>
                        </div>
                        <div id="school-file-status" class="file-status"></div>
                    </div>
                    <div class="upload-box" id="liveschool-dropzone">
                        <div class="dropzone-content">
                            <div class="upload-icon csv-icon">
                                <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                    <rect x="8" y="4" width="32" height="40" rx="2" fill="#2b6cb0" stroke="#3182ce" stroke-width="2"/>
                                    <text x="24" y="28" text-anchor="middle" fill="white" font-size="10" font-weight="bold">CSV</text>
                                </svg>
                            </div>
                            <label for="liveschool-file">LiveSchool CSV Export</label>
                            <input type="file" id="liveschool-file" accept=".csv">
                            <button type="button" class="select-file-btn">Select File</button>
                            <p class="upload-hint">or drag & drop here</p>
                            <p class="upload-desc">
                                Exported roster with student IDs
                                <span class="help-tooltip" title="Export from LiveSchool: Students > Export. Must include 'id', 'First Name*', 'Last Name*' columns.">?</span>
                            </p>
                        </div>
                        <div id="liveschool-file-status" class="file-status"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 2: Column Mapping -->
        <section class="step assign-step locked" id="step-columns" data-step="2">
            <div class="step-header">
                <h2><span class="step-badge">2</span> Select Name Column(s)</h2>
                <span class="lock-icon" title="Complete Step 1 to unlock">üîí</span>
            </div>
            <div class="step-content">
                <p>How are student names formatted in the school's file?</p>

                <div class="column-mode-selector">
                    <label class="column-mode-option">
                        <input type="radio" name="column-mode" value="combined" checked>
                        <span class="mode-label">Combined column</span>
                        <span class="mode-desc">"Last Name, First Name" in one column</span>
                    </label>
                    <label class="column-mode-option">
                        <input type="radio" name="column-mode" value="separate">
                        <span class="mode-label">Separate columns</span>
                        <span class="mode-desc">Last Name and First Name in different columns</span>
                    </label>
                </div>

                <div id="combined-column-selector" class="column-selector-group">
                    <h4>Select the name column:</h4>
                    <div id="column-selector"></div>
                </div>

                <div id="separate-column-selector" class="column-selector-group hidden">
                    <div class="separate-column-row">
                        <div class="separate-column-section">
                            <h4>Select the Last Name column:</h4>
                            <div id="last-name-column-selector"></div>
                        </div>
                        <div class="separate-column-section">
                            <h4>Select the First Name column:</h4>
                            <div id="first-name-column-selector"></div>
                        </div>
                    </div>
                </div>

                <button id="confirm-column" class="btn primary">Confirm Column Selection</button>
            </div>
        </section>

        <!-- Step 3: School Configuration -->
        <section class="step assign-step locked" id="step-config" data-step="3">
            <div class="step-header">
                <h2><span class="step-badge">3</span> School Configuration</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <p class="step-description">Enter the IDs for this school (found in LiveSchool URLs or network requests)</p>
                <div class="config-grid">
                    <div class="config-field">
                        <label for="roster-id">Roster ID</label>
                        <input type="text" id="roster-id" placeholder="e.g., 12345">
                    </div>
                    <div class="config-field">
                        <label for="location-id">Location ID</label>
                        <input type="text" id="location-id" placeholder="e.g., 678">
                    </div>
                    <div class="config-field">
                        <label for="school-id">School ID</label>
                        <input type="text" id="school-id" placeholder="e.g., 99">
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 4: Tab/Behavior Mapping -->
        <section class="step assign-step locked" id="step-behaviors" data-step="4">
            <div class="step-header">
                <h2><span class="step-badge">4</span> Assign Behaviors to Tabs</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <p>Enter the behavior ID and type for each tab in the school's file.</p>
                <div class="bulk-actions">
                    <button id="apply-to-all" class="btn secondary">Apply to All Tabs</button>
                    <div class="bulk-inputs">
                        <input type="text" id="bulk-behavior-id" placeholder="Behavior ID">
                        <select id="bulk-behavior-type">
                            <option value="merit">Merit</option>
                            <option value="demerit">Demerit</option>
                        </select>
                    </div>
                </div>
                <div id="tab-behavior-list"></div>
            </div>
        </section>

        <!-- Step 5: Match & Review -->
        <section class="step assign-step locked" id="step-match" data-step="5">
            <div class="step-header">
                <h2><span class="step-badge">5</span> Review Matches</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <button id="run-matching" class="btn primary">
                    <span class="btn-text">Run Matching</span>
                    <span class="btn-spinner hidden"></span>
                </button>
                <div id="match-summary" class="hidden">
                    <div class="match-stats">
                        <div class="stat-card matched">
                            <div class="stat-icon">‚úì</div>
                            <div class="stat-number" id="matched-count">0</div>
                            <div class="stat-label">Matched</div>
                        </div>
                        <div class="stat-card unmatched">
                            <div class="stat-icon">‚ö†</div>
                            <div class="stat-number" id="unmatched-count">0</div>
                            <div class="stat-label">Unmatched</div>
                        </div>
                        <div class="stat-card percentage">
                            <div class="stat-icon" id="match-indicator">‚óè</div>
                            <div class="stat-number" id="match-percentage">0%</div>
                            <div class="stat-label">Match Rate</div>
                        </div>
                    </div>
                </div>
                <div id="unmatched-list" class="hidden">
                    <h3>Unmatched Students</h3>
                    <p class="hint">Select the correct match from the dropdown, or leave as "No match" to skip.</p>
                    <div id="unmatched-items"></div>
                </div>
            </div>
        </section>

        <!-- Step 6: Generate Output -->
        <section class="step assign-step locked" id="step-output" data-step="6">
            <div class="step-header">
                <h2><span class="step-badge">6</span> Generated Scripts</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <button id="generate-scripts" class="btn primary">Generate Scripts</button>
                <div id="scripts-output">
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>Your scripts will appear here once generated</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================= -->
        <!-- DEMO MODE SECTIONS (hidden by default) -->
        <!-- ============================================= -->

        <!-- Demo Step 1: Upload LiveSchool CSV -->
        <section class="step demo-step hidden" id="demo-step-upload">
            <div class="step-header">
                <h2><span class="step-badge">1</span> Upload Student Data</h2>
            </div>
            <div class="step-content">
                <div class="upload-box single" id="demo-liveschool-dropzone">
                    <div class="dropzone-content">
                        <div class="upload-icon">üìä</div>
                        <label for="demo-liveschool-file">LiveSchool CSV Export</label>
                        <input type="file" id="demo-liveschool-file" accept=".csv">
                        <p class="upload-hint">Drag & drop or click to select</p>
                        <p class="upload-desc">Export from LiveSchool with student IDs</p>
                    </div>
                    <div id="demo-liveschool-file-status" class="file-status"></div>
                </div>
            </div>
        </section>

        <!-- Demo Step 2: Site Configuration -->
        <section class="step demo-step hidden locked" id="demo-step-config">
            <div class="step-header">
                <h2><span class="step-badge">2</span> Site Configuration</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <p class="step-description">Enter the IDs for this demo site (found in LiveSchool URLs or network requests)</p>
                <div class="config-grid">
                    <div class="config-field">
                        <label for="demo-roster-id">Roster ID</label>
                        <input type="text" id="demo-roster-id" placeholder="e.g., 12345">
                    </div>
                    <div class="config-field">
                        <label for="demo-location-id">Location ID</label>
                        <input type="text" id="demo-location-id" placeholder="e.g., 678">
                    </div>
                    <div class="config-field">
                        <label for="demo-school-id">School ID</label>
                        <input type="text" id="demo-school-id" placeholder="e.g., 99">
                    </div>
                </div>
            </div>
        </section>

        <!-- Demo Step 3: Behavior Configuration -->
        <section class="step demo-step hidden locked" id="demo-step-behaviors">
            <div class="step-header">
                <h2><span class="step-badge">3</span> Configure Behaviors</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <p class="step-description">Add the behaviors to use for demo data. Use the discovery script to find behavior IDs.</p>

                <div class="behavior-discovery">
                    <div class="discovery-actions">
                        <button id="show-discovery-script" class="btn secondary">Show Behavior Discovery Script</button>
                        <button id="copy-discovery-script" class="copy-btn">Copy Script</button>
                    </div>
                    <div id="discovery-script-container" class="hidden">
                        <p class="hint">Paste this script in the LiveSchool browser console while logged in:</p>
                        <pre class="discovery-code"><code class="language-javascript" id="discovery-script-code"></code></pre>
                    </div>
                </div>

                <div class="behavior-import">
                    <h4>Import from Discovery Script</h4>
                    <p class="hint">Paste the JSON output from the discovery script:</p>
                    <div class="import-row">
                        <textarea id="import-behaviors-json" placeholder='[{"id":"12345","name":"Following Rules","type":"merit"},...]' rows="2"></textarea>
                        <button id="import-behaviors" class="btn primary">Import</button>
                    </div>
                </div>

                <div class="behavior-add-form">
                    <h4>Or Add Manually</h4>
                    <div class="behavior-input-row">
                        <input type="text" id="new-behavior-id" placeholder="Behavior ID">
                        <input type="text" id="new-behavior-name" placeholder="Name (optional)">
                        <select id="new-behavior-type">
                            <option value="merit">Merit (+)</option>
                            <option value="demerit">Demerit (-)</option>
                        </select>
                        <button id="add-behavior" class="btn secondary">Add</button>
                    </div>
                </div>

                <div id="behavior-list" class="behavior-list">
                    <div class="empty-state small">
                        <p>No behaviors added yet</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Demo Step 4: Demo Settings -->
        <section class="step demo-step hidden locked" id="demo-step-settings">
            <div class="step-header">
                <h2><span class="step-badge">4</span> Demo Settings</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <div class="settings-grid">
                    <div class="setting-group">
                        <h4>Date Range</h4>
                        <div class="date-inputs">
                            <div class="config-field">
                                <label for="demo-start-date">Start Date</label>
                                <input type="date" id="demo-start-date">
                            </div>
                            <div class="config-field">
                                <label for="demo-end-date">End Date</label>
                                <input type="date" id="demo-end-date">
                            </div>
                        </div>
                        <p class="hint">Points will only be assigned on weekdays (Mon-Fri)</p>
                    </div>

                    <div class="setting-group">
                        <h4>Points Per Student</h4>
                        <div class="points-inputs">
                            <div class="config-field">
                                <label for="demo-min-points">Minimum</label>
                                <input type="number" id="demo-min-points" value="15" min="1">
                            </div>
                            <div class="config-field">
                                <label for="demo-max-points">Maximum</label>
                                <input type="number" id="demo-max-points" value="40" min="1">
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <h4>Positive to Negative Ratio</h4>
                        <div class="ratio-selector">
                            <select id="demo-ratio">
                                <option value="3">3:1 (75% positive)</option>
                                <option value="4" selected>4:1 (80% positive)</option>
                                <option value="5">5:1 (83% positive)</option>
                                <option value="6">6:1 (86% positive)</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <div id="custom-ratio-inputs" class="hidden">
                                <input type="number" id="demo-custom-positive" value="4" min="1" max="20">
                                <span>:</span>
                                <input type="number" id="demo-custom-negative" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Demo Step 5: Generate Demo Script -->
        <section class="step demo-step hidden locked" id="demo-step-generate">
            <div class="step-header">
                <h2><span class="step-badge">5</span> Generate Demo Script</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <div id="demo-preview" class="demo-preview hidden">
                    <h4>Preview</h4>
                    <div class="preview-stats">
                        <div class="preview-stat">
                            <span class="preview-label">Students</span>
                            <span class="preview-value" id="preview-students">0</span>
                        </div>
                        <div class="preview-stat">
                            <span class="preview-label">Date Range</span>
                            <span class="preview-value" id="preview-dates">-</span>
                        </div>
                        <div class="preview-stat">
                            <span class="preview-label">Weekdays</span>
                            <span class="preview-value" id="preview-weekdays">0</span>
                        </div>
                        <div class="preview-stat">
                            <span class="preview-label">Est. Total Points</span>
                            <span class="preview-value" id="preview-total-points">0</span>
                        </div>
                        <div class="preview-stat">
                            <span class="preview-label">Positive Points</span>
                            <span class="preview-value positive" id="preview-positive">0</span>
                        </div>
                        <div class="preview-stat">
                            <span class="preview-label">Negative Points</span>
                            <span class="preview-value negative" id="preview-negative">0</span>
                        </div>
                    </div>
                </div>

                <button id="generate-demo-script" class="btn primary">Generate Demo Script</button>

                <div id="demo-scripts-output">
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>Your demo script will appear here once generated</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================= -->
        <!-- BALANCE TRANSFER MODE SECTIONS (hidden by default) -->
        <!-- ============================================= -->

        <!-- Balance Step 1: Upload Files -->
        <section class="step balance-step hidden" id="balance-step-upload">
            <div class="step-header">
                <h2><span class="step-badge">1</span> Upload Files</h2>
            </div>
            <div class="step-content">
                <p class="step-description">Upload the school's balance file and the LiveSchool CSV export to match students.</p>
                <div class="upload-grid">
                    <div class="upload-box" id="balance-source-dropzone">
                        <div class="dropzone-content">
                            <div class="upload-icon">üìÑ</div>
                            <label for="balance-source-file">School Balance File (CSV)</label>
                            <input type="file" id="balance-source-file" accept=".csv">
                            <p class="upload-hint">Drag & drop or click to select</p>
                            <p class="upload-desc">File with student names and point balances</p>
                        </div>
                        <div id="balance-source-file-status" class="file-status"></div>
                    </div>
                    <div class="upload-box" id="balance-liveschool-dropzone">
                        <div class="dropzone-content">
                            <div class="upload-icon">üìä</div>
                            <label for="balance-liveschool-file">LiveSchool CSV Export</label>
                            <input type="file" id="balance-liveschool-file" accept=".csv">
                            <p class="upload-hint">Drag & drop or click to select</p>
                            <p class="upload-desc">Export from LiveSchool with student IDs</p>
                        </div>
                        <div id="balance-liveschool-file-status" class="file-status"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Balance Step 2: Column Selection & Config -->
        <section class="step balance-step hidden locked" id="balance-step-columns">
            <div class="step-header">
                <h2><span class="step-badge">2</span> Configuration</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <div class="balance-config-section">
                    <h4>Reward ID</h4>
                    <p class="hint">Enter your school's reward ID. You can find this in the network request when manually adding a transaction in LiveSchool's banking section.</p>
                    <div class="config-field" style="max-width: 200px;">
                        <input type="text" id="balance-reward-id" placeholder="e.g., 209969">
                    </div>
                </div>

                <h4 style="margin-top: 1.5rem;">Select Columns</h4>
                <p>Select which columns contain the student names and point amounts.</p>

                <div class="balance-column-selectors">
                    <div class="balance-column-section">
                        <h4>Student Name Column:</h4>
                        <p class="hint">Select the column with names in "FirstName LastName" format</p>
                        <div id="balance-name-column-selector"></div>
                    </div>
                    <div class="balance-column-section">
                        <h4>Points Column:</h4>
                        <p class="hint">Select the column with the point balance to transfer</p>
                        <div id="balance-points-column-selector"></div>
                    </div>
                </div>

                <button id="balance-confirm-columns" class="btn primary">Confirm Column Selection</button>
            </div>
        </section>

        <!-- Balance Step 3: Review Matches -->
        <section class="step balance-step hidden locked" id="balance-step-match">
            <div class="step-header">
                <h2><span class="step-badge">3</span> Review Matches</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <button id="balance-run-matching" class="btn primary">
                    <span class="btn-text">Run Matching</span>
                    <span class="btn-spinner hidden"></span>
                </button>
                <div id="balance-match-summary" class="hidden">
                    <div class="match-stats">
                        <div class="stat-card matched">
                            <div class="stat-icon">‚úì</div>
                            <div class="stat-number" id="balance-matched-count">0</div>
                            <div class="stat-label">Matched</div>
                        </div>
                        <div class="stat-card unmatched">
                            <div class="stat-icon">‚ö†</div>
                            <div class="stat-number" id="balance-unmatched-count">0</div>
                            <div class="stat-label">Unmatched</div>
                        </div>
                        <div class="stat-card percentage">
                            <div class="stat-icon" id="balance-match-indicator">‚óè</div>
                            <div class="stat-number" id="balance-match-percentage">0%</div>
                            <div class="stat-label">Match Rate</div>
                        </div>
                        <div class="stat-card total-points">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-number" id="balance-total-points">0</div>
                            <div class="stat-label">Total Points</div>
                        </div>
                    </div>
                </div>
                <div id="balance-unmatched-list" class="hidden">
                    <h3>Unmatched Students</h3>
                    <p class="hint">Select the correct match from the dropdown, or leave as "No match" to skip.</p>
                    <div id="balance-unmatched-items"></div>
                </div>
            </div>
        </section>

        <!-- Balance Step 4: Generate Script -->
        <section class="step balance-step hidden locked" id="balance-step-generate">
            <div class="step-header">
                <h2><span class="step-badge">4</span> Generate Transfer Script</h2>
                <span class="lock-icon" title="Complete previous steps to unlock">üîí</span>
            </div>
            <div class="step-content">
                <button id="balance-generate-script" class="btn primary">Generate Script</button>
                <div id="balance-scripts-output">
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>Your transfer script will appear here once generated</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

        <!-- ============================================= -->
        <!-- MERGE STUDENTS MODE SECTIONS (hidden by default) -->
        <!-- ============================================= -->

        <!-- Merge Step 1: Student IDs & Config -->
        <section class="step merge-step hidden" id="merge-step-ids">
            <div class="step-header">
                <h2><span class="step-badge">1</span> Student IDs & Site Config</h2>
            </div>
            <div class="step-content">
                <p class="step-description">Enter the original (source) and new (target) student IDs, plus site configuration.</p>
                <h4>Student IDs</h4>
                <div class="config-grid">
                    <div class="config-field">
                        <label for="merge-original-id">Original Student ID (source)</label>
                        <input type="text" id="merge-original-id" placeholder="e.g., 4097396">
                    </div>
                    <div class="config-field">
                        <label for="merge-new-id">New Student ID (target)</label>
                        <input type="text" id="merge-new-id" placeholder="e.g., 4149727">
                    </div>
                </div>
                <h4 style="margin-top: 1.5rem;">Site Configuration</h4>
                <div class="config-grid">
                    <div class="config-field">
                        <label for="merge-roster-id">Roster ID</label>
                        <input type="text" id="merge-roster-id" placeholder="e.g., 893673">
                    </div>
                    <div class="config-field">
                        <label for="merge-location-id">Location ID</label>
                        <input type="text" id="merge-location-id" placeholder="e.g., 19320">
                    </div>
                    <div class="config-field">
                        <label for="merge-school-id">School ID</label>
                        <input type="text" id="merge-school-id" placeholder="e.g., 3946">
                    </div>
                    <div class="config-field">
                        <label for="merge-user-id">User ID <span class="hint">(optional ‚Äî for purchases)</span></label>
                        <input type="text" id="merge-user-id" placeholder="e.g., 123456">
                    </div>
                </div>
            </div>
        </section>

        <!-- Merge Step 2: Upload Points Log -->
        <section class="step merge-step hidden locked" id="merge-step-upload">
            <div class="step-header">
                <h2><span class="step-badge">2</span> Upload Points Log</h2>
                <span class="lock-icon" title="Enter student IDs and site config to unlock">üîí</span>
            </div>
            <div class="step-content">
                <p class="step-description">Upload the extended data export (TSV) for the original student's transaction history.</p>
                <div class="upload-box single" id="merge-log-dropzone">
                    <div class="dropzone-content">
                        <div class="upload-icon csv-icon">
                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                <rect x="8" y="4" width="32" height="40" rx="2" fill="#2b6cb0" stroke="#3182ce" stroke-width="2"/>
                                <text x="24" y="28" text-anchor="middle" fill="white" font-size="10" font-weight="bold">TSV</text>
                            </svg>
                        </div>
                        <label for="merge-log-file">Extended Data Export (TSV)</label>
                        <input type="file" id="merge-log-file" accept=".tsv,.csv,.txt">
                        <button type="button" class="select-file-btn">Select File</button>
                        <p class="upload-hint">or drag & drop here</p>
                        <p class="upload-desc">
                            Tab-separated export with Record ID, Behavior Name, Date, Time
                            <span class="help-tooltip" title="Export from LiveSchool: Extended Data export. Must contain columns: Record ID, Behavior / Reward Name, Official Date, Official Time, Type.">?</span>
                        </p>
                    </div>
                    <div id="merge-log-file-status" class="file-status"></div>
                </div>
            </div>
        </section>

        <!-- Merge Step 3: Behavior Map -->
        <section class="step merge-step hidden locked" id="merge-step-behaviors">
            <div class="step-header">
                <h2><span class="step-badge">3</span> Behavior Map</h2>
                <span class="lock-icon" title="Upload points log to unlock">üîí</span>
            </div>
            <div class="step-content">
                <p class="step-description">Paste the behavior JSON from the LiveSchool API to map behavior names to IDs.</p>
                <p class="hint">In the browser console while logged into LiveSchool, run: <code>fetch('/v2/schools/{schoolId}/behaviors', {credentials:'include'}).then(r=>r.json()).then(d=>console.log(JSON.stringify(d)))</code></p>
                <textarea id="merge-behavior-json" placeholder='Paste the JSON response from /v2/schools/{schoolId}/behaviors here...' rows="4"></textarea>
                <button id="merge-import-behaviors" class="btn primary">Import Behaviors</button>
                <div id="merge-behavior-list" class="hidden">
                    <h4>Imported Behaviors (<span id="merge-behavior-count">0</span>)</h4>
                    <div id="merge-behavior-items"></div>
                </div>
            </div>
        </section>

        <!-- Merge Step 4: Review Transactions -->
        <section class="step merge-step hidden locked" id="merge-step-review">
            <div class="step-header">
                <h2><span class="step-badge">4</span> Review Transactions</h2>
                <span class="lock-icon" title="Import behavior map to unlock">üîí</span>
            </div>
            <div class="step-content">
                <button id="merge-parse-transactions" class="btn primary">Parse Transactions</button>

                <div id="merge-transaction-summary" class="hidden">
                    <div class="match-stats merge-stats">
                        <div class="stat-card matched">
                            <div class="stat-icon">‚úì</div>
                            <div class="stat-number" id="merge-mapped-count">0</div>
                            <div class="stat-label">Mapped</div>
                        </div>
                        <div class="stat-card unmatched">
                            <div class="stat-icon">‚ö†</div>
                            <div class="stat-number" id="merge-unmapped-count">0</div>
                            <div class="stat-label">Unmapped</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-number" id="merge-group-count">0</div>
                            <div class="stat-label">API Calls</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üõí</div>
                            <div class="stat-number" id="merge-purchase-count">0</div>
                            <div class="stat-label">Purchases</div>
                        </div>
                    </div>
                </div>

                <div id="merge-unmapped-behaviors" class="hidden">
                    <h3>Unmapped Behaviors</h3>
                    <p class="hint">These behavior names from the export could not be matched to a behavior ID. Select the correct behavior or skip.</p>
                    <div id="merge-unmapped-items"></div>
                </div>

                <div id="merge-unmapped-rewards" class="hidden">
                    <h3>Unmapped Rewards</h3>
                    <p class="hint">Enter the incentive ID for each reward. Find IDs in LiveSchool's network tab when purchasing an item (look for the <code>incentives</code> field in POST /v2/rewards).</p>
                    <div id="merge-unmapped-reward-items"></div>
                </div>

                <div id="merge-transaction-table" class="hidden">
                    <h3>Transaction Groups (<span id="merge-groups-total">0</span>)</h3>
                    <p class="hint">Each group becomes one API call. Showing first 50.</p>
                    <div id="merge-groups-list"></div>
                </div>
            </div>
        </section>

        <!-- Merge Step 5: Generate Script -->
        <section class="step merge-step hidden locked" id="merge-step-generate">
            <div class="step-header">
                <h2><span class="step-badge">5</span> Generate Merge Script</h2>
                <span class="lock-icon" title="Review transactions to unlock">üîí</span>
            </div>
            <div class="step-content">
                <button id="merge-generate-script" class="btn primary">Generate Script</button>
                <div id="merge-scripts-output">
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>Your merge script will appear here once generated</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    </div><!-- End app-container -->

    <script src="js/parser.js"></script>
    <script src="js/matcher.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
